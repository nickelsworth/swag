<html>
<head><title> "INI File Handler" by KIM GREVE</title><link rel="STYLESHEET" type="text/css" href="../swagsource.css"></head>
<body><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0158.PAS">Original</a><b>]</b></p><!--StartFragment--><pre><code><font color="#008000"><i>(*
   unit INIF

   Unit that handles .INI files in almost the same way as the functions
   with the same name used under windows.
   ---------------------------------------------------------------------

   GetProfileString(AppName, Section, EntryName, EntryValue, Default);

   The GetProfileString function retrieves a character string from a
   specified [section] and a specified EntryName in the. INI file
   specified in AppName.

   parameter  | description
   -----------+---------------------------------------------------------
   AppName    | The name of the .INI file.
              | You do not need to type .INI after the path:\filename.
              |
   Section    | The [Section] where you want to search for the EntryName
              | don't put [ ] around the section name.
              |
   EntryName  | String containing the entry whose associated string is
              | to be retrieved. For more see the following Comment
              | section.
              |
   EntryValue | The returned string for the actual EntryName.
              |
   Default    | String that specifies the default value(string) for the
              | given entry if the entry cannot be found in the INI file
   ---------------------------------------------------------------------
   Returns:
   GetProfileString returns the length of retrieved string (EntryValue).

   Comment:
   The function searches the file for an entry that matches the name
   specified by the 'EntryName' parameter under the section heading
   specified by the 'Section' parameter. If the entry is found,
   EntryValue is altered to the string in EntryName. If the entry does
   not exist, the default value specified by the Default parameter is
   used instead. A string entry must have the following form:

   [Section]
   EntryName=EntryValue
     .
     .
   The Section, EntryName and EntryValue is not case-dependent. With
   every compare all the strings is in uppercase.

   ---------------------------------------------------------------------

   WriteProfileString(AppName, Section, EntryName, EntryValue);

   The WriteProfileString function copies a character string into the
   specified [section] and a specified EntryName in the .INI file
   specified in AppName.

   parameter  | description
   -----------+---------------------------------------------------------
   AppName    | The name of the .INI file.
              | You do not need to type .INI after the path:\filename.
   Section    | The [Section] to witch the string will by copied. If the
              | section does not exist, it is created. The name of the
              | section is not case-dependent; the string may be any
              | combination of uppercase and lowercase letters.
              | (don't put [ ] around the section name.)
   EntryName  | String containing the entry whose to be associated with
              | the string. If the entry does not exist in the specified
              | section, it is created.
   EntryValue | The string whose to be associated with EntryName.
   ---------------------------------------------------------------------
   Returns:
   WriteProfileString returns zero if write was successful otherwise -1.

   Comment:
   Sections in the .ini file have the following form:

   [Section]
   EntryName=EntryValue
     .
     .
   The Section, EntryName and EntryValue is not case-dependent. With
   every compare all the strings is converted into uppercase.
   ---------------------------------------------------------------------
   GetProfileInt and WriteProfileInt works in the same way, the only
   difference is that EntryValue must be an integer type instead of a
   string type.
   ---------------------------------------------------------------------
   procedure DisposeINICollection;

     The procedure disposes the collection from memory.

   you can call this procedure if you want to dispose the collection,
   the procedure is called before an .ini file is loaded and in the
   unit's exitprocedure, to make sure that the memory used by the
   collection is released before the program terminates.
   ---------------------------------------------------------------------
   to flush the collection in memory call WriteProfileString, with the
   [Section] AND [EntryName] AND EntryValue set to 'NILL' (NILL is NOT
   a type error) see Flush collection.

   Flush Collection:
   -----------------

     WriteProfileString(AppName, 'NILL', 'NILL', 'NILL');

   if you for don't want the collection to be flushed to disk when the
   program terminates, you must call the DisposeINICollection procedure
   that releases the memory used by the collection and sets INIColl to
   NIL or set INIF_FlushOnExit to FALSE.

   Delete ENTRY:
   -------------

     WriteProfileString(AppName, Section, EntryName, 'NILL');

   Delete SECTION:
   ---------------

     WriteProfileString(AppName, Section, 'NILL', 'NILL');

   ---------------------------------------------------------------------

   Performance:
   To improve performance a copy of the ini file is kept in a collection
   and to flush the collection to a file, you have to call the procedure
   WriteProfileString with 3 NILL parameters.

   ---------------------------------------------------------------------
    (c) 1994 by Kim Greve.
    This is given to the public domain,  so if you want to make changes
    feel free to do it, my only demand/request is that you don't remove
    my name.
    If you have any questions, suggestions or have found any bugs,
    please contact me.
   
    DISCLAIMER:
    This source is given as is, you can not hold me responsibly for any
    errors in the source (if any &lt;g&gt;).
   +-------------------------------+-----------------------------------+
   + Last changed: December, 27-1994                                   +
   +-------------------------------+-----------------------------------+
   + Kim Greve                     + Internet:                         +
   + Krebsens kvt 9F               + 1. kim.greve@dkb.dk               +
   + 2620 Albertslund.             +                                   +
   + Denmark.                      + 2. kimgreve@inet.uni-c.dk         +
   +-------------------------------+-----------------------------------+
*)

(*
Eks.

program INIFTest;
uses INIF;
var
  S: String;
begin
  {
  Get Teststring1 form the file &quot;TEST.INI&quot;, in section [Test Section],
  the file &quot;TEST.INI&quot; don't exist, so then default string 'ThisIsATest'
  is returned in S. GetProfileString returns the length of the returned
  string.
  }
  GetProfileString('Test', 'Test Section', 'Number', S, 'ThisIsATest');
  {
  Write TestString1 to the file &quot;TEST.INI&quot;, Section &quot;Test Section&quot; and
  store the contens of TestString1 in AString (EntryName).
  }
  WriteProfileString('Test', 'Test Section', 'AString', TestString1);
  {
  Until now is all the writing have been to a collection in memory,
  and to make the .ini file the collection have to be Flushed.
  }
  WriteProfileString('Test', 'NILL', 'NILL', 'NILL');
  { You actualy don't have to do this, the collection is flushed when }
  { you terminate the program - UNLESS you have set INIF_FlushOnExit  }
  { = FALSE, the default is INIF_FlushOnExit = TRUE.                  }
end.
*)

</i></font><font color="#FF0000"><b>unit </b></font>INIF<font color="#000080">;

</font><font color="#FF0000"><b>interface

uses
  </b></font>Dos<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>INIF_FlushOnExit<font color="#000080">: </font>Boolean <font color="#000080">= </font>True<font color="#000080">;</font><font color="#008000"><i>{ flush collection when terminating }
  </i></font>INIF_ReadError<font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">;      </font><font color="#008000"><i>{ true if an readerror acurred }
  </i></font>INIF_WriteError<font color="#000080">: </font>Boolean <font color="#000080">= </font>False<font color="#000080">;    </font><font color="#008000"><i>{ true if an writeerror acurred }


</i></font><font color="#FF0000"><b>function </b></font>GetProfileString<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">, </font>EntryName<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                          </font><font color="#FF0000"><b>var </b></font>EntryValue<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                          </font><font color="#FF0000"><b>Default</b></font><font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>WriteProfileString<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">,
                            </font>EntryName<font color="#000080">, </font>EntryValue<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>GetProfileInt<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">, </font>EntryName<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                       </font><font color="#FF0000"><b>var </b></font>EntryValue<font color="#000080">: </font>Integer<font color="#000080">;
                       </font><font color="#FF0000"><b>Default</b></font><font color="#000080">: </font>Integer<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>function </b></font>WriteProfileInt<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">, </font>EntryName<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                         </font>EntryValue<font color="#000080">: </font>Integer<font color="#000080">): </font>Integer<font color="#000080">;


</font><font color="#FF0000"><b>procedure </b></font>DisposeINICollection<font color="#000080">;

</font><font color="#FF0000"><b>implementation

uses </b></font>Objects<font color="#000080">;

</font><font color="#FF0000"><b>const
  </b></font>CommentChar<font color="#000080">: </font>Char <font color="#000080">= </font><font color="#800000">';'</font><font color="#000080">;          </font><font color="#008000"><i>{ character leading a comment line }
                                    { used i SplitEntry                }

</i></font><font color="#FF0000"><b>var
  </b></font>INIFile<font color="#000080">: </font>PathStr<font color="#000080">;                                 </font><font color="#008000"><i>{ default filename }
  </i></font>BakINIFile<font color="#000080">: </font>PathStr<font color="#000080">;                       </font><font color="#008000"><i>{ default backup filename }
  </i></font>TempINIFile<font color="#000080">: </font>PathStr<font color="#000080">;                        </font><font color="#008000"><i>{ default temp filename }
  </i></font>OrgINIExitProc<font color="#000080">: </font>Pointer<font color="#000080">;
  </font>INIColl<font color="#000080">: </font>PStringCollection<font color="#000080">;         </font><font color="#008000"><i>{ copy of the INI file in memory }
  </i></font>SectionIndexStart<font color="#000080">: </font>Integer<font color="#000080">;         </font><font color="#008000"><i>{ start of section in collection }
  </i></font>SectionIndexend<font color="#000080">: </font>Integer<font color="#000080">;             </font><font color="#008000"><i>{ end of section in collection }

{ Convert a string to uppercase, handles danish chars to }
</i></font><font color="#FF0000"><b>function </b></font>UpcaseStr<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>AString<font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">: </font>Integer<font color="#000080">;
  </font>S<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>S <font color="#000080">:= </font><font color="#FF0000"><b>String</b></font><font color="#000080">(</font>AString<font color="#000080">);
  </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">1 </font><font color="#FF0000"><b>to </b></font>Length<font color="#000080">(</font>S<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>S<font color="#000080">[</font>I<font color="#000080">] := </font>Upcase<font color="#000080">(</font>S<font color="#000080">[</font>I<font color="#000080">]);
    </font><font color="#FF0000"><b>if  </b></font>S<font color="#000080">[</font>I<font color="#000080">] = </font><font color="#800000">'ë' </font><font color="#FF0000"><b>then </b></font>S<font color="#000080">[</font>I<font color="#000080">] := </font><font color="#800000">'í'
    </font><font color="#FF0000"><b>else if  </b></font>S<font color="#000080">[</font>I<font color="#000080">] = </font><font color="#800000">'õ' </font><font color="#FF0000"><b>then </b></font>S<font color="#000080">[</font>I<font color="#000080">] := </font><font color="#800000">'ù'
    </font><font color="#FF0000"><b>else if  </b></font>S<font color="#000080">[</font>I<font color="#000080">] = </font><font color="#800000">'Ü' </font><font color="#FF0000"><b>then </b></font>S<font color="#000080">[</font>I<font color="#000080">] := </font><font color="#800000">'è'</font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
 </font>UpcaseStr <font color="#000080">:= </font>S<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ returns true if file is exist }
</i></font><font color="#FF0000"><b>function </b></font>FileExist<font color="#000080">(</font>FName<font color="#000080">: </font>PathStr<font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>SR<font color="#000080">: </font>SearchRec<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FindFirst<font color="#000080">(</font>FName<font color="#000080">, </font>Archive<font color="#000080">, </font>SR<font color="#000080">);
  </font>FileExist <font color="#000080">:= </font>True <font color="#000080">= (</font>DosError <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ read a line from the file }
</i></font><font color="#FF0000"><b>function </b></font>ReadLine<font color="#000080">(</font><font color="#FF0000"><b>var </b></font>F<font color="#000080">: </font>Text<font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Ch<font color="#000080">: </font>Char<font color="#000080">;
  </font>Line<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Line <font color="#000080">:= </font><font color="#800000">''</font><font color="#000080">;
  </font>Ch <font color="#000080">:= </font><font color="#800000">#13</font><font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>Ch <font color="#000080">&lt;&gt; </font><font color="#800000">#10</font><font color="#000080">) </font><font color="#FF0000"><b>and not </b></font>Eof<font color="#000080">(</font>F<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    if </b></font>Ch <font color="#000080">&lt;&gt; </font><font color="#800000">#13 </font><font color="#FF0000"><b>then </b></font>Line <font color="#000080">:= </font>Line <font color="#000080">+ </font>Ch<font color="#000080">;
    </font>Read<font color="#000080">(</font>F<font color="#000080">, </font>Ch<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ add Ch to Line if last entry not folowed by #13/#10 }
  </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Eof<font color="#000080">(</font>F<font color="#000080">)) </font><font color="#FF0000"><b>and </b></font><font color="#000080">((</font>Ch <font color="#000080">&lt;&gt; </font><font color="#800000">#10</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>Ch <font color="#000080">&lt;&gt; </font><font color="#800000">#13</font><font color="#000080">)) </font><font color="#FF0000"><b>then </b></font>Line <font color="#000080">:= </font>Line <font color="#000080">+ </font>Ch<font color="#000080">;
  </font>ReadLine <font color="#000080">:= </font>Line<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>ReadINIFile<font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>F<font color="#000080">: </font>Text<font color="#000080">;
  </font>Line<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ReadINIFile <font color="#000080">:= </font>True<font color="#000080">;
  </font>DisposeINICollection<font color="#000080">;  </font><font color="#008000"><i>{ make sure to release memory before new read }
  </i></font>INIColl <font color="#000080">:= </font>New<font color="#000080">(</font>PStringCollection<font color="#000080">, </font>Init<font color="#000080">(</font><font color="#800000">1</font><font color="#000080">, </font><font color="#800000">1</font><font color="#000080">));
  </font><font color="#FF0000"><b>if </b></font>INIColl <font color="#000080">= </font><font color="#FF0000"><b>nil then
  begin
    </b></font>ReadINIFile <font color="#000080">:= </font>False<font color="#000080">;
    </font>Exit<font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>INIColl<font color="#000080">^.</font>Duplicates <font color="#000080">:= </font>True<font color="#000080">;      </font><font color="#008000"><i>{ duplicates allowed in collection }
  </i></font><font color="#FF0000"><b>if not </b></font>FileExist<font color="#000080">(</font>INIFile<font color="#000080">) </font><font color="#FF0000"><b>then </b></font>Exit<font color="#000080">;
  </font><font color="#008000"><i>{$I-}
  </i></font>Assign<font color="#000080">(</font>F<font color="#000080">, </font>INIFile<font color="#000080">);
  </font>Reset<font color="#000080">(</font>F<font color="#000080">);
  </font>INIF_ReadError <font color="#000080">:= </font>True <font color="#000080">= (</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);          </font><font color="#008000"><i>{ check for error }
  </i></font><font color="#FF0000"><b>if not </b></font>INIF_ReadError <font color="#FF0000"><b>then
  begin
    While </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>Eof<font color="#000080">(</font>F<font color="#000080">)) </font><font color="#FF0000"><b>and not </b></font>INIF_ReadError <font color="#FF0000"><b>do
    begin
      </b></font>Line <font color="#000080">:= </font>ReadLine<font color="#000080">(</font>F<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Line <font color="#000080">&lt;&gt; </font><font color="#800000">''</font><font color="#000080">) </font><font color="#FF0000"><b>then
        </b></font>INIColl<font color="#000080">^.</font>AtInsert<font color="#000080">(</font>INIColl<font color="#000080">^.</font>Count<font color="#000080">, </font>NewStr<font color="#000080">(</font>Line<font color="#000080">));
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{$I+}
  </i></font>ReadINIFile <font color="#000080">:= </font>INIF_ReadError<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>SaveINIFile<font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>I<font color="#000080">: </font>Integer<font color="#000080">;
  </font>OrgF<font color="#000080">, </font>BakF<font color="#000080">, </font>TempF<font color="#000080">: </font>Text<font color="#000080">;
  </font>IOError<font color="#000080">: </font>Boolean<font color="#000080">;
  </font>Line<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font><font color="#008000"><i>{$I-}
  </i></font>Assign<font color="#000080">(</font>OrgF<font color="#000080">, </font>INIFile<font color="#000080">);
  </font>Assign<font color="#000080">(</font>BakF<font color="#000080">, </font>BakINIFile<font color="#000080">);
  </font>Assign<font color="#000080">(</font>TempF<font color="#000080">, </font>TempINIFile<font color="#000080">);
  </font>ReWrite<font color="#000080">(</font>TempF<font color="#000080">);                                   </font><font color="#008000"><i>{ create .TMP file }
  </i></font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>INIColl<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
  begin
    </b></font>Line <font color="#000080">:= </font>PString<font color="#000080">(</font>INIColl<font color="#000080">^.</font>At<font color="#000080">(</font>I<font color="#000080">))^;
    </font><font color="#008000"><i>{ if next line is a new section then make a linefeed }
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>Line<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">'['</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>I <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>WriteLn<font color="#000080">(</font>TempF<font color="#000080">);
    </font>WriteLn<font color="#000080">(</font>TempF<font color="#000080">, </font>Line<font color="#000080">);
    </font>INIF_WriteError <font color="#000080">:= </font>True <font color="#000080">= (</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font>Close<font color="#000080">(</font>TempF<font color="#000080">);                                           </font><font color="#008000"><i>{ close file }
  </i></font>IOError <font color="#000080">:= </font>True <font color="#000080">= (</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);                 </font><font color="#008000"><i>{ check for error }
  { if a .bak file exist, erase it }
  </i></font><font color="#FF0000"><b>if </b></font>FileExist<font color="#000080">(</font>BakINIFile<font color="#000080">) </font><font color="#FF0000"><b>and not </b></font>IOError <font color="#FF0000"><b>then </b></font>Erase<font color="#000080">(</font>BakF<font color="#000080">);
  </font>IOError <font color="#000080">:= </font>True <font color="#000080">= (</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);                 </font><font color="#008000"><i>{ check for error }
  { if a .ini file exist, rename it to .bak }
  </i></font><font color="#FF0000"><b>if </b></font>FileExist<font color="#000080">(</font>INIFile<font color="#000080">) </font><font color="#FF0000"><b>and not </b></font>IOError <font color="#FF0000"><b>then
  begin
    </b></font>Rename<font color="#000080">(</font>OrgF<font color="#000080">, </font>BakINIFile<font color="#000080">);
    </font>IOError <font color="#000080">:= </font>True <font color="#000080">= (</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);               </font><font color="#008000"><i>{ check for error }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{ rename .tmp file to .ini }
  </i></font><font color="#FF0000"><b>if </b></font>FileExist<font color="#000080">(</font>TempINIFile<font color="#000080">) </font><font color="#FF0000"><b>and not </b></font>IOError <font color="#FF0000"><b>then
  begin
    </b></font>Rename<font color="#000080">(</font>TempF<font color="#000080">, </font>INIFile<font color="#000080">);
    </font>IOError <font color="#000080">:= </font>True <font color="#000080">= (</font>IOResult <font color="#000080">&lt;&gt; </font><font color="#800000">0</font><font color="#000080">);               </font><font color="#008000"><i>{ check for error }
  </i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#008000"><i>{$I+}
  </i></font><font color="#FF0000"><b>if </b></font>INIF_WriteError <font color="#FF0000"><b>or </b></font>IOError <font color="#FF0000"><b>then </b></font>SaveINIFile <font color="#000080">:= </font>False <font color="#FF0000"><b>else
    </b></font>SaveINIFile <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ returns True if section exist. The 2 global var's: SectionIndexStart }
{ &amp; SectionIndexEnd is effected by this function                       }
</i></font><font color="#FF0000"><b>function </b></font>FindSection<font color="#000080">(</font>Section<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Ch<font color="#000080">: </font>Char<font color="#000080">;
  </font>S<font color="#000080">, </font>Line<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>StartFound<font color="#000080">, </font>EndFound<font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FindSection <font color="#000080">:= </font>False<font color="#000080">;
  </font>StartFound <font color="#000080">:= </font>False<font color="#000080">;
  </font>EndFound <font color="#000080">:= </font>False<font color="#000080">;
  </font>S <font color="#000080">:= </font><font color="#800000">'['</font><font color="#000080">+</font>Section<font color="#000080">;
  </font>Section <font color="#000080">:= </font>S<font color="#000080">+</font><font color="#800000">']'</font><font color="#000080">;
  </font>Section <font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font>Section<font color="#000080">);

  </font><font color="#008000"><i>{ find start of Section }
  </i></font>SectionIndexStart <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
  </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>StartFound<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>INIColl<font color="#000080">^.</font>Count <font color="#000080">&gt; </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>and
    </b></font><font color="#000080">(</font>SectionIndexStart <font color="#000080">&lt; </font>INIColl<font color="#000080">^.</font>Count<font color="#000080">) </font><font color="#FF0000"><b>do
  begin
    </b></font>Line <font color="#000080">:= </font>PString<font color="#000080">(</font>INIColl<font color="#000080">^.</font>At<font color="#000080">(</font>SectionIndexStart<font color="#000080">))^;
    </font><font color="#FF0000"><b>if </b></font>Line<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">'[' </font><font color="#FF0000"><b>then
    begin
      </b></font>Line <font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font>Line<font color="#000080">);
      </font>Line<font color="#000080">[</font><font color="#800000">0</font><font color="#000080">] := </font>Chr<font color="#000080">(</font>Pos<font color="#000080">(</font><font color="#800000">']'</font><font color="#000080">, </font>Line<font color="#000080">));
      </font><font color="#FF0000"><b>if </b></font>Line <font color="#000080">= </font>Section <font color="#FF0000"><b>then </b></font>StartFound <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>StartFound<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>SectionIndexStart <font color="#000080">&lt; </font>INIColl<font color="#000080">^.</font>Count<font color="#000080">) </font><font color="#FF0000"><b>then
      </b></font>Inc<font color="#000080">(</font>SectionIndexStart<font color="#000080">);
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;

  </font><font color="#008000"><i>{ find end of Section if start of section is found }
  </i></font>SectionIndexEnd <font color="#000080">:= </font>SectionIndexStart<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>StartFound <font color="#FF0000"><b>then
  begin
    While </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>EndFound<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>SectionIndexEnd <font color="#000080">&lt; </font>INIColl<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>do
    begin
      if </b></font>SectionIndexEnd <font color="#000080">&lt; </font>INIColl<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font>Inc<font color="#000080">(</font>SectionIndexEnd<font color="#000080">);
      </font>Line <font color="#000080">:= </font>PString<font color="#000080">(</font>INIColl<font color="#000080">^.</font>At<font color="#000080">(</font>SectionIndexEnd<font color="#000080">))^;
      </font><font color="#FF0000"><b>if </b></font>Line<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] = </font><font color="#800000">'[' </font><font color="#FF0000"><b>then </b></font>EndFound <font color="#000080">:= </font>True<font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>StartFound <font color="#FF0000"><b>then </b></font>FindSection <font color="#000080">:= </font>True<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ returns EntryName. Value is returned in EntryValue }
</i></font><font color="#FF0000"><b>function </b></font>SplitEntry<font color="#000080">(</font>EntryName<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">; </font><font color="#FF0000"><b>var </b></font>EntryValue<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Entry<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>EntryName<font color="#000080">[</font><font color="#800000">1</font><font color="#000080">] &lt;&gt; </font>CommentChar <font color="#FF0000"><b>then
  begin
    </b></font>Entry <font color="#000080">:= </font>Copy<font color="#000080">(</font>EntryName<font color="#000080">, </font><font color="#800000">1</font><font color="#000080">, </font>Pos<font color="#000080">(</font><font color="#800000">'='</font><font color="#000080">, </font>EntryName<font color="#000080">)-</font><font color="#800000">1</font><font color="#000080">);
    </font>EntryValue <font color="#000080">:= </font>Copy<font color="#000080">(</font>EntryName<font color="#000080">,
      </font>Pos<font color="#000080">(</font><font color="#800000">'='</font><font color="#000080">, </font>EntryName<font color="#000080">)+</font><font color="#800000">1</font><font color="#000080">, </font>Length<font color="#000080">(</font>EntryName<font color="#000080">));
  </font><font color="#FF0000"><b>end
  else </b></font>Entry <font color="#000080">:= </font>CommentChar<font color="#000080">;
  </font>SplitEntry <font color="#000080">:= </font>Entry<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ returns Index of Entry if it exist, -1 if not, -2 if section don't   }
{ exist.                                                               }
</i></font><font color="#FF0000"><b>function </b></font>FindEntry<font color="#000080">(</font>Section<font color="#000080">, </font>Entry<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                   </font><font color="#FF0000"><b>var </b></font>EntryValue<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Ch<font color="#000080">: </font>Char<font color="#000080">;
  </font>S<font color="#000080">, </font>Line<font color="#000080">, </font>TempLine<font color="#000080">, </font>TempEntryValue<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>SectionIndex<font color="#000080">: </font>Integer<font color="#000080">;
  </font>EntryFound<font color="#000080">: </font>Boolean<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FindEntry <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;                    </font><font color="#008000"><i>{ exspect that entry don't exist }
  </i></font><font color="#FF0000"><b>if </b></font>FindSection<font color="#000080">(</font>Section<font color="#000080">) </font><font color="#FF0000"><b>then
  begin
    </b></font>EntryFound <font color="#000080">:= </font>False<font color="#000080">;
    </font>SectionIndex <font color="#000080">:= </font>SectionIndexStart<font color="#000080">;
    </font>Entry <font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font>Entry<font color="#000080">);
    </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font><font color="#FF0000"><b>not </b></font>EntryFound<font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>SectionIndex <font color="#000080">&lt;= </font>SectionIndexEnd<font color="#000080">) </font><font color="#FF0000"><b>do
    begin
      </b></font>Line <font color="#000080">:= </font>PString<font color="#000080">(</font>INIColl<font color="#000080">^.</font>At<font color="#000080">(</font>SectionIndex<font color="#000080">))^;
      </font>TempLine <font color="#000080">:= </font>Line<font color="#000080">;              </font><font color="#008000"><i>{ work on a copy of original line }
      </i></font>TempLine <font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font>TempLine<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>SplitEntry<font color="#000080">(</font>TempLine<font color="#000080">, </font>TempEntryValue<font color="#000080">) = </font>Entry <font color="#FF0000"><b>then
      begin
        </b></font><font color="#008000"><i>{ return EntryValue not converted to UpCase }
        </i></font>SplitEntry<font color="#000080">(</font>Line<font color="#000080">, </font>EntryValue<font color="#000080">);
        </font>EntryFound <font color="#000080">:= </font>True<font color="#000080">;
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
      </font><font color="#FF0000"><b>if not </b></font>EntryFound <font color="#FF0000"><b>then </b></font>Inc<font color="#000080">(</font>SectionIndex<font color="#000080">);
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>if </b></font>EntryFound <font color="#FF0000"><b>then </b></font>FindEntry <font color="#000080">:= </font>SectionIndex<font color="#000080">;
  </font><font color="#FF0000"><b>end
  else </b></font>FindEntry <font color="#000080">:= -</font><font color="#800000">2</font><font color="#000080">;   </font><font color="#008000"><i>{ return -2 to tell that section don't exist }
</i></font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>procedure </b></font>SetINIFileName<font color="#000080">(</font>FName<font color="#000080">: </font>PathStr<font color="#000080">);
</font><font color="#FF0000"><b>var
  </b></font>D<font color="#000080">: </font>DirStr<font color="#000080">;
  </font>N<font color="#000080">: </font>NameStr<font color="#000080">;
  </font>E<font color="#000080">: </font>ExtStr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FName <font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font>FName<font color="#000080">);
  </font>FSplit<font color="#000080">(</font>FName<font color="#000080">, </font>D<font color="#000080">, </font>N<font color="#000080">, </font>E<font color="#000080">);
  </font>INIFile <font color="#000080">:= </font>N<font color="#000080">+</font><font color="#800000">'.INI'</font><font color="#000080">;
  </font>BakINIFile <font color="#000080">:= </font>N<font color="#000080">+</font><font color="#800000">'.BAK'</font><font color="#000080">;
  </font>TempINIFile <font color="#000080">:= </font>N<font color="#000080">+</font><font color="#800000">'.TMP'</font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;


</font><font color="#008000"><i>{- functions / procedures in interface section ------------------------}

</i></font><font color="#FF0000"><b>function </b></font>GetProfileString<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">, </font>EntryName<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                          </font><font color="#FF0000"><b>var </b></font>EntryValue<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                          </font><font color="#FF0000"><b>Default</b></font><font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>D<font color="#000080">: </font>DirStr<font color="#000080">;
  </font>N<font color="#000080">: </font>NameStr<font color="#000080">;
  </font>E<font color="#000080">: </font>ExtStr<font color="#000080">;
  </font><font color="#FF0000"><b>ON</b></font><font color="#000080">, </font>NN<font color="#000080">: </font>NameStr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>FSplit<font color="#000080">(</font>INIFile<font color="#000080">, </font>D<font color="#000080">, </font>N<font color="#000080">, </font>E<font color="#000080">);
  </font><font color="#FF0000"><b>ON </b></font><font color="#000080">:= </font>N<font color="#000080">;
  </font>FSplit<font color="#000080">(</font>AppName<font color="#000080">, </font>D<font color="#000080">, </font>N<font color="#000080">, </font>E<font color="#000080">);
  </font>NN <font color="#000080">:= </font>N<font color="#000080">;
  </font><font color="#FF0000"><b>ON </b></font><font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font><font color="#FF0000"><b>ON</b></font><font color="#000080">);
  </font>NN <font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font>NN<font color="#000080">);
  </font><font color="#008000"><i>{ make sure that INIColl = nil, if OldName &lt;&gt; NewName }
  { (= another .ini file)                            }
  </i></font><font color="#FF0000"><b>if ON </b></font><font color="#000080">&lt;&gt; </font>NN <font color="#FF0000"><b>then </b></font>DisposeINICollection<font color="#000080">;
  </font>SetINIFileName<font color="#000080">(</font>AppName<font color="#000080">);
  </font>EntryValue <font color="#000080">:= </font><font color="#FF0000"><b>Default</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>INIColl <font color="#000080">= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>ReadINIFile<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font>INIColl <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>FindEntry<font color="#000080">(</font>Section<font color="#000080">, </font>EntryName<font color="#000080">, </font>EntryValue<font color="#000080">);
  </font>GetProfileString <font color="#000080">:= </font>Length<font color="#000080">(</font>EntryValue<font color="#000080">);
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>WriteProfileString<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">,
                            </font>EntryName<font color="#000080">, </font>EntryValue<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>i<font color="#000080">, </font>EntryIndex<font color="#000080">: </font>Integer<font color="#000080">;
  </font>OrgF<font color="#000080">: </font>Text<font color="#000080">;
  </font>Line<font color="#000080">, </font>Dummy<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>D<font color="#000080">: </font>DirStr<font color="#000080">;
  </font>N<font color="#000080">: </font>NameStr<font color="#000080">;
  </font>E<font color="#000080">: </font>ExtStr<font color="#000080">;
  </font><font color="#FF0000"><b>ON</b></font><font color="#000080">, </font>NN<font color="#000080">: </font>NameStr<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>WriteProfileString <font color="#000080">:= -</font><font color="#800000">1</font><font color="#000080">;
  </font>SetINIFileName<font color="#000080">(</font>AppName<font color="#000080">);
  </font>FSplit<font color="#000080">(</font>INIFile<font color="#000080">, </font>D<font color="#000080">, </font>N<font color="#000080">, </font>E<font color="#000080">);
  </font><font color="#FF0000"><b>ON </b></font><font color="#000080">:= </font>N<font color="#000080">;
  </font>FSplit<font color="#000080">(</font>AppName<font color="#000080">, </font>D<font color="#000080">, </font>N<font color="#000080">, </font>E<font color="#000080">);
  </font>NN <font color="#000080">:= </font>N<font color="#000080">;
  </font><font color="#FF0000"><b>ON </b></font><font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font><font color="#FF0000"><b>ON</b></font><font color="#000080">);
  </font>NN <font color="#000080">:= </font>UpcaseStr<font color="#000080">(</font>NN<font color="#000080">);
  </font><font color="#008000"><i>{ make sure that INIColl = nil if OldName &lt;&gt; NewName }
  { (= another .ini file)                              }
  </i></font><font color="#FF0000"><b>if ON </b></font><font color="#000080">&lt;&gt; </font>NN <font color="#FF0000"><b>then </b></font>DisposeINICollection<font color="#000080">;
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>INIColl <font color="#000080">= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>ReadINIFile<font color="#000080">;

  </font><font color="#FF0000"><b>if </b></font>INIColl <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then
  begin
    </b></font><font color="#008000"><i>{ flush collection to .INI file ? }
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>INIColl <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>and
       </b></font><font color="#000080">((</font>UpcaseStr<font color="#000080">(</font>Section<font color="#000080">) = </font><font color="#800000">'NILL'</font><font color="#000080">) </font><font color="#FF0000"><b>and
        </b></font><font color="#000080">(</font>UpcaseStr<font color="#000080">(</font>EntryName<font color="#000080">) = </font><font color="#800000">'NILL'</font><font color="#000080">) </font><font color="#FF0000"><b>and
        </b></font><font color="#000080">(</font>UpcaseStr<font color="#000080">(</font>EntryValue<font color="#000080">) = </font><font color="#800000">'NILL'</font><font color="#000080">)) </font><font color="#FF0000"><b>then
    begin
      if </b></font>SaveINIFile <font color="#FF0000"><b>then </b></font>WriteProfileString <font color="#000080">:= </font><font color="#800000">0</font><font color="#000080">;
      </font>Exit<font color="#000080">;
    </font><font color="#FF0000"><b>end
    </b></font><font color="#008000"><i>{ delete Section ? }
    </i></font><font color="#FF0000"><b>else
    if </b></font><font color="#000080">(</font>EntryName <font color="#000080">= </font><font color="#800000">'NILL'</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>EntryValue <font color="#000080">= </font><font color="#800000">'NILL'</font><font color="#000080">) </font><font color="#FF0000"><b>and
      </b></font>FindSection<font color="#000080">(</font>Section<font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font><font color="#008000"><i>{ adjust SectionIndexEnd if the section is the last section }
      { in the .ini file                                          }
      </i></font><font color="#FF0000"><b>if </b></font>SectionIndexEnd <font color="#000080">= </font>INIColl<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>then </b></font>Inc<font color="#000080">(</font>SectionIndexEnd<font color="#000080">);

      </font><font color="#FF0000"><b>While </b></font><font color="#000080">(</font>SectionIndexStart <font color="#000080">&lt; </font>SectionIndexEnd<font color="#000080">) </font><font color="#FF0000"><b>and
            </b></font><font color="#000080">(</font>SectionIndexEnd <font color="#000080">&lt;= </font>INIColl<font color="#000080">^.</font>Count<font color="#000080">) </font><font color="#FF0000"><b>do
      begin
        </b></font>INIColl<font color="#000080">^.</font>AtFree<font color="#000080">(</font>SectionIndexStart<font color="#000080">);
        </font>Dec<font color="#000080">(</font>SectionIndexEnd<font color="#000080">);
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end
    else
    </b></font><font color="#008000"><i>{ delete Entry ? }
    </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>EntryValue <font color="#000080">= </font><font color="#800000">'NILL'</font><font color="#000080">) </font><font color="#FF0000"><b>then
    begin
      </b></font>EntryIndex <font color="#000080">:= </font>FindEntry<font color="#000080">(</font>Section<font color="#000080">, </font>EntryName<font color="#000080">, </font>Dummy<font color="#000080">);
      </font><font color="#FF0000"><b>if </b></font>EntryIndex <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
        </b></font>INIColl<font color="#000080">^.</font>AtFree<font color="#000080">(</font>EntryIndex<font color="#000080">);                  </font><font color="#008000"><i>{ dispose string }
    </i></font><font color="#FF0000"><b>end
    else
    begin
      </b></font>EntryIndex <font color="#000080">:= </font>FindEntry<font color="#000080">(</font>Section<font color="#000080">, </font>EntryName<font color="#000080">, </font>Dummy<font color="#000080">);
      </font><font color="#008000"><i>{ if EntryName is found, then replace the old string with the    }
      { new string.                                                    }
      </i></font><font color="#FF0000"><b>if </b></font>EntryIndex <font color="#000080">&gt; </font><font color="#800000">0 </font><font color="#FF0000"><b>then
      begin
        </b></font>DisposeStr<font color="#000080">(</font>INIColl<font color="#000080">^.</font>At<font color="#000080">(</font>EntryIndex<font color="#000080">));  </font><font color="#008000"><i>{ dispose the old string }
        </i></font>INIColl<font color="#000080">^.</font>AtPut<font color="#000080">(</font>EntryIndex<font color="#000080">, </font>NewStr<font color="#000080">(</font>EntryName<font color="#000080">+</font><font color="#800000">'='</font><font color="#000080">+</font>EntryValue<font color="#000080">));
      </font><font color="#FF0000"><b>end
      else
      </b></font><font color="#008000"><i>{ if FindEntry returns -1 then the entry does not exist. So      }
      { insert the new entry at index returned by FindEntry.           }
      { if EntryValue = NILL, don't do anyting.                        }
      </i></font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>EntryValue <font color="#000080">&lt;&gt; </font><font color="#800000">'NILL'</font><font color="#000080">) </font><font color="#FF0000"><b>and </b></font><font color="#000080">(</font>EntryIndex <font color="#000080">= -</font><font color="#800000">1</font><font color="#000080">) </font><font color="#FF0000"><b>then
      begin
        for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>INIColl<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
          </b></font>Line <font color="#000080">:= </font>PString<font color="#000080">(</font>INIColl<font color="#000080">^.</font>At<font color="#000080">(</font>I<font color="#000080">))^;
        </font><font color="#FF0000"><b>if </b></font>SectionIndexEnd <font color="#000080">&lt; </font>INIColl<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>then
          </b></font>INIColl<font color="#000080">^.</font>AtInsert<font color="#000080">(</font>SectionIndexEnd<font color="#000080">,
            </font>NewStr<font color="#000080">(</font>EntryName<font color="#000080">+</font><font color="#800000">'='</font><font color="#000080">+</font>EntryValue<font color="#000080">))
        </font><font color="#FF0000"><b>else
          </b></font>INIColl<font color="#000080">^.</font>AtInsert<font color="#000080">(</font>INIColl<font color="#000080">^.</font>Count<font color="#000080">,
            </font>NewStr<font color="#000080">(</font>EntryName<font color="#000080">+</font><font color="#800000">'='</font><font color="#000080">+</font>EntryValue<font color="#000080">));
        </font><font color="#FF0000"><b>for </b></font>I <font color="#000080">:= </font><font color="#800000">0 </font><font color="#FF0000"><b>to </b></font>INIColl<font color="#000080">^.</font>Count<font color="#000080">-</font><font color="#800000">1 </font><font color="#FF0000"><b>do
          </b></font>Line <font color="#000080">:= </font>PString<font color="#000080">(</font>INIColl<font color="#000080">^.</font>At<font color="#000080">(</font>I<font color="#000080">))^;
      </font><font color="#FF0000"><b>end
      else
      </b></font><font color="#008000"><i>{ if FindEntry returns -2 then the section does not exist. So    }
      { insert the new section and entry at the end.                   }
      </i></font><font color="#FF0000"><b>if </b></font>EntryIndex <font color="#000080">= -</font><font color="#800000">2 </font><font color="#FF0000"><b>then
      begin
        </b></font>INIColl<font color="#000080">^.</font>AtInsert<font color="#000080">(</font>INIColl<font color="#000080">^.</font>Count<font color="#000080">, </font>NewStr<font color="#000080">(</font><font color="#800000">'['</font><font color="#000080">+</font>Section<font color="#000080">+</font><font color="#800000">']'</font><font color="#000080">));
        </font>INIColl<font color="#000080">^.</font>AtInsert<font color="#000080">(</font>INIColl<font color="#000080">^.</font>Count<font color="#000080">,
          </font>NewStr<font color="#000080">(</font>EntryName<font color="#000080">+</font><font color="#800000">'='</font><font color="#000080">+</font>EntryValue<font color="#000080">));
      </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
    </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
  </font><font color="#FF0000"><b>end</b></font><font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>GetProfileInt<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">, </font>EntryName<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                       </font><font color="#FF0000"><b>var </b></font>EntryValue<font color="#000080">: </font>Integer<font color="#000080">;
                       </font><font color="#FF0000"><b>Default</b></font><font color="#000080">: </font>Integer<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>Def<font color="#000080">, </font>S<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>E<font color="#000080">, </font>R<font color="#000080">, </font>L<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Str<font color="#000080">(</font><font color="#FF0000"><b>Default</b></font><font color="#000080">, </font>Def<font color="#000080">);
  </font>L <font color="#000080">:= </font>GetProfileString<font color="#000080">(</font>AppName<font color="#000080">, </font>Section<font color="#000080">, </font>EntryName<font color="#000080">, </font>S<font color="#000080">, </font>Def<font color="#000080">);
  </font>Val<font color="#000080">(</font>S<font color="#000080">, </font>R<font color="#000080">, </font>E<font color="#000080">);
  </font><font color="#FF0000"><b>if </b></font><font color="#000080">(</font>E <font color="#000080">= </font><font color="#800000">0</font><font color="#000080">) </font><font color="#FF0000"><b>then </b></font>EntryValue <font color="#000080">:= </font>R <font color="#FF0000"><b>else </b></font>EntryValue <font color="#000080">:= </font><font color="#FF0000"><b>Default</b></font><font color="#000080">;
  </font>GetProfileInt <font color="#000080">:= </font>L<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>function </b></font>WriteProfileInt<font color="#000080">(</font>AppName<font color="#000080">: </font>PathStr<font color="#000080">; </font>Section<font color="#000080">, </font>EntryName<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
                         </font>EntryValue<font color="#000080">: </font>Integer<font color="#000080">): </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>var
  </b></font>S<font color="#000080">: </font><font color="#FF0000"><b>String</b></font><font color="#000080">;
  </font>L<font color="#000080">: </font>Integer<font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>Str<font color="#000080">(</font>EntryValue<font color="#000080">, </font>S<font color="#000080">);
  </font>L <font color="#000080">:= </font>WriteProfileString<font color="#000080">(</font>AppName<font color="#000080">, </font>Section<font color="#000080">, </font>EntryName<font color="#000080">, </font>S<font color="#000080">);
  </font>WriteProfileInt <font color="#000080">:= </font>L<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{ if a copy of the .ini file is in memory then release the memory used }
</i></font><font color="#FF0000"><b>procedure </b></font>DisposeINICollection<font color="#000080">;
</font><font color="#FF0000"><b>begin
  if </b></font>INIColl <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil then </b></font>Dispose<font color="#000080">(</font>INIColl<font color="#000080">, </font>Done<font color="#000080">);
  </font>INIColl <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>INIF_ReadError <font color="#000080">:= </font>False<font color="#000080">;
  </font>INIF_WriteError <font color="#000080">:= </font>False<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#008000"><i>{--- unit init &amp; exit preb. -------------------------------------------}

</i></font><font color="#FF0000"><b>procedure </b></font>INIFExitProc<font color="#000080">; </font><font color="#FF0000"><b>far</b></font><font color="#000080">;
</font><font color="#FF0000"><b>begin
  </b></font>ExitProc <font color="#000080">:= </font>OrgINIExitProc<font color="#000080">;
  </font><font color="#008000"><i>{ flush the collection }
  </i></font><font color="#FF0000"><b>if </b></font>INIF_FlushOnExit <font color="#FF0000"><b>and </b></font><font color="#000080">(</font>INIColl <font color="#000080">&lt;&gt; </font><font color="#FF0000"><b>nil</b></font><font color="#000080">) </font><font color="#FF0000"><b>then
    </b></font>WriteProfileString<font color="#000080">(</font>INIFile<font color="#000080">, </font><font color="#800000">'NILL'</font><font color="#000080">, </font><font color="#800000">'NILL'</font><font color="#000080">, </font><font color="#800000">'NILL'</font><font color="#000080">);
  </font>DisposeINICollection<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">;

</font><font color="#FF0000"><b>begin
  </b></font>INIColl <font color="#000080">:= </font><font color="#FF0000"><b>nil</b></font><font color="#000080">;
  </font>OrgINIExitProc <font color="#000080">:= </font>ExitProc<font color="#000080">;
  </font>ExitProc <font color="#000080">:= @</font>INIFExitProc<font color="#000080">;
</font><font color="#FF0000"><b>end</b></font><font color="#000080">.
</font>
</code></pre><!--EndFragment--><p align="center"><b>[</b><a href="index.html">Back to MISC SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="../index.html">Back to Main SWAG index</a><b>]</b>&nbsp;&nbsp;<b>[</b><a href="0158.PAS">Original</a><b>]</b></p></body>
</html>
